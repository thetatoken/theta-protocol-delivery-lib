!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ThetaHlsJsFragmentLoader=t():e.ThetaHlsJsFragmentLoader=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(a){if(r[a])return r[a].exports;var n=r[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,a){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){e.exports=r(1)},function(e,t,r){"use strict";function a(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function a(n,o){try{var i=t[n](o),u=i.value}catch(e){return void r(e)}if(!i.done)return Promise.resolve(u).then(function(e){a("next",e)},function(e){a("throw",e)});e(u)}return a("next")})}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),l=function e(t,r,a){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,r);if(void 0===n){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,a)}if("value"in n)return n.value;var i=n.get;if(void 0!==i)return i.call(a)},s=r(2),f=function(e){return e&&e.__esModule?e:{default:e}}(s),c=!1,d=function(e){function t(){return n(this,t),o(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return i(t,e),u(t,[{key:"rangeCheck",value:function(e){var t=this;$.ajax({type:"head",async:!0,url:e.url,crossdomain:!0,beforeSend:function(){f.default.log("Sending HEAD request to url "+e.url),t.segmentEtag=null,t.contentLength=null}}).done(function(e,r,a){t.contentLength=a.getResponseHeader("Content-Length"),t.segmentEtag=a.getResponseHeader("etag"),f.default.log("HEAD request successful, etag="+t.segmentEtag)})}},{key:"integrityCheck",value:function(e){if(f.default.log("integrityCheck etag="+this.segmentEtag),this.segmentEtag){var t=md5(e),r='"'===this.segmentEtag[0]?this.segmentEtag.substring(1,this.segmentEtag.length-1):this.segmentEtag;return f.default.log("verifying md5 checksum of the segment md5sum="+t),t===r}return!0}},{key:"load",value:function(e,t,r){var a=this;if(f.default.info("URL "+e.url+" Range end "+e.rangeEnd),f.default.info("ctx: ",e),this.thetaCtx.cache.has(e.url+e.rangeEnd))f.default.info("load from cache - ",e.url,e.rangeEnd),this.loadFromCache(e,t,r);else if(null===this.thetaCtx.p2p.id)f.default.info("not connected to peerjs, load from CDN..."),this.loadFromCDN_old(e,t,r);else if(this.thetaCtx.p2p.useCDN&&c)f.default.info("configuration has useCDN enabled, load from CDN..."),this.loadFromCDN_old(e,t,r);else{var n=this.thetaCtx.p2p,o=this.thetaCtx.playerStats,i=this;if(0===Object.keys(n.peers).length){f.default.info("no peer yet for "+n.id+", load from UCN");Math.floor(Date.now());this.tryLoadFromUCN(e,t,r)}else{var u=Math.floor(Date.now()),l=this.thetaCtx.p2p.probeTimeout,s=i._getNewUrl(e.url);f.default.info("New URL before probe is: ",s,e.rangeEnd);var d=this._getCDNLoadedPercent(n.counterMap)>.5?Math.ceil(6*Math.random())-3:Math.ceil(3*Math.random())+1;f.default.info("IMPROVE DEBUG - p2p object before probe is:",n.counterMap),n.probeFromPeerWithTimeout(s+e.rangeEnd,l,1,d).then(function(l){f.default.info("SPLIT DEBUG - response after probe:",l);var c=Math.floor(Date.now());f.default.info("probeFromPeerWithTimeout - fragment "+(s+e.rangeEnd)+" found from peer "+l.peerid);var d=l.peerid;o.processFragmentReq(d,"probe_req_overview_replied"),o.processProbeReq(d,c-u);var g=n.failoverFactor,h=Math.floor(1e3*e.frag.duration*g);f.default.info("IMPROVE DEBUG - duration:"+e.frag.duration+", factor:"+g+", fragment timeout:"+h);var p=new Array(6);n.loadFromSpecificPeerWithTimeout(s+e.rangeEnd,d,h,5,p).then(function(i){f.default.log("IMPROVE DEBUG - resp after load from peer:",i);var u=void 0;i.forEach(function(e){void 0!==e&&(u=e)}),"kOK"===u.result?(f.default.log("SPLIT DEBUG - kOk res of loadFromSpecificPeerWithTimeout:",u),f.default.log("SPLIT DEBUG - data in kOk:",p),f.default.log("SPLIT DEBUG - ctx in kOK:",e),f.default.warn("IMPROVE DEBUG [BL] - Load from peer success, updating the get fragment results map"),n.updateGetFragResults(d,"success",5),a.loadFromPeer(e,u,d,o,c,n,r,p,t)):(f.default.warn("remote peer "+d+" reject getFragment req, try CDN"),f.default.warn("IMPROVE DEBUG [BL] - Load from peer failed, updating the get fragment results map"),n.updateGetFragResults(d,"failed",5),o.processFragmentReq(d,"fragment_req_rejected"),a.tryLoadFromUCN(e,t,r))}).catch(function(u){f.default.warn("loadFromSpecificPeer gets timeout, "+e.url+" try CDN  - "+d);var l=p.slice(0);l.invoice=p.invoice,f.default.log("IMPROVE DEBUG - newData in catch:",l),u.message?f.default.error("error message -",u.message):f.default.error("error without msg -",u);var s=0;if(l.forEach(function(e){e&&"number"!=typeof e&&s++}),f.default.info("IMPROVE DEBUG - loaded segment length:",s),l[l.length-1]){var g=l.reduce(function(e,t){return i._appendBuffer(e,t)},new ArrayBuffer);if(n.updateGetFragResults(d,"success",s),n.updateGetFragResults(d,"failed",5-s),g.byteLength===l[l.length-1]){f.default.log("SPLIT DEBUG - [corner case] In corner case!");var y={data:g,invoice:l.invoice,totalLength:g.byteLength,type:"fragment",url:e.url};a.loadFromPeer(e,y,d,o,c,n,r)}else!function(){for(var t=[],i=0;i<l.length;i++)void 0===l[i]&&t.push(i);f.default.info("IMPROVE DEBUG - unloadSegment:",t),o.processFragmentReq(d,"fragment_req_timeout"),a.loadPartFromPeer(e.url,l,g.byteLength,d,h,o,n),e.totalNum=5;for(var u=[],s=0;s<t.length;s++)!function(n){var o=new Promise(function(o,i){setTimeout(function(){var i=Object.assign({},e),u=Object.assign({},r);o(a.loadFromCDN(i,t[n],u,l)),f.default.log("IMPROVE DEBUG - In part CDN setTimeout times:",n)},n*h/10),f.default.log("IMPROVE DEBUG - In part CDN Timeout:",n*h/10)});u.push(o),f.default.log("IMPROVE DEBUG - In part CDN in loop times:",n)}(s)}()}else n.updateGetFragResults(d,"failed",5),o.processFragmentReq(d,"fragment_req_timeout"),f.default.log("SPLIT DEBUG - load from cdn use the old function."),a.tryLoadFromUCN(e,t,r)})}).catch(function(n){f.default.warn("probeFromPeerWithTimeout ends, "+l+" timeout"),f.default.warn("probeFromPeerWithTimeout ends with err: ",n);var o=a.thetaCtx.playerStats;"timeout"===n.type?o.processFragmentReq(null,"probe_req_overview_timeout"):o.processFragmentReq(null,"probe_req_overview_notCached"),a.tryLoadFromUCN(e,t,r)})}}}},{key:"loadFromCache",value:function(e,t,r){var a=e.url+e.rangeEnd;f.default.info("Serving from cache: ",a);var n=this.thetaCtx.cache,o=n.get(a);f.default.info("cachedItem: ",o);var i=null,u=null;null!==o&&void 0!==o&&(i=o[0].data.slice(0),u=o[1]);var l={data:i,url:e.url};f.default.info("response: ",l),f.default.info("cachedData: ",i),f.default.info("response: ",l),r.onSuccess(l,u,e)}},{key:"tryLoadFromUCN",value:function(e,t,r){var a=this;if(f.default.info("Loading url: ",e.url),this.thetaCtx.p2p.useUCN){var n=this.thetaCtx.p2p.ucn,o="https://"+n.host+":8080/live/"+this.thetaCtx.p2p.videoId+"/ucnmap.json";e.originalUrl=e.url,e.url=this._getNewUrl(e.url),this.getUcnMap(o,e.url).then(function(o){var i=o;e.ucnMap=Object.assign({},i),e.cdnUrl=e.url,e.url="https://"+n.host+":8080/live/"+i[e.cdnUrl],a.loadFromUCN(e,t,r)}).catch(function(n){f.default.info("getUcnMap returns an error: ",n),f.default.info("getUcnMap didn't have the key, load from CDN"),e.url=e.originalUrl,a.loadFromCDN_old(e,t,r)})}else f.default.info("useUCN is false, load from CDN"),this.loadFromCDN_old(e,t,r)}},{key:"getUcnMap",value:function(e,t){return new Promise(function(r,n){var o=this;$.ajax({type:"get",async:!0,url:e,crossdomain:!0}).done(function(){var e=a(regeneratorRuntime.mark(function e(a,i,u){var l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:l=JSON.parse(a),f.default.debug("UCN map is: ",l),l.hasOwnProperty(t)?r(l):(f.default.info("UCN map doesn't have "+t+" as a key"),n("Error - no matched key"));case 3:case"end":return e.stop()}},e,o)}));return function(t,r,a){return e.apply(this,arguments)}}())})}},{key:"loadPartFromPeer",value:function(e,t,r,a,n,o,i){f.default.log("SPLIT DEBUG - IN load part from peer"),f.default.log("SPLIT DEBUG - data",t),f.default.log("SPLIT DEBUG - url",e),f.default.log("SPLIT DEBUG - peerid",a);var u=null;t.invoice&&(u=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:r},peer:{id:a,address:u}}),o.processFragment(e,"fromPeer",r,n),o.processFragmentReq(a,"fragment_req_replied");var l=i.peers[a];try{t.invoice?i.shouldSendPayment(t,a)?(f.default.log("SPLIT DEBUG - Sending payment to "+t.invoice.address),i.sendPayment(t.invoice,l)):f.default.log("SPLIT DEBUG - Should not send payment. Skipping payment."):f.default.log("SPLIT DEBUG - No invoice is included in peer response. Skipping payment.")}catch(e){f.default.error("Error sending payment: ",e)}}},{key:"loadFromPeer",value:function(e,t,r,a,n,o,i){f.default.info("fragment "+t.url+" received from peer "+r);var u={url:t.url,data:t.data},l={size:t.data.byteLength,loaded:t.data.byteLength,trequest:performance.now()},s=Math.floor(Date.now()),c=null;if(f.default.info("getFragment from peer, takes "+(s-n)+" ms"),!this.integrityCheck(u.data.slice(0)))return void f.default.error("segment integrity check (from peer) fails, skip loading");t.invoice&&(c=t.invoice.address),this.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:u.data.byteLength},peer:{id:r,address:c}});var d=this._getNewUrl(e.url);f.default.info("Key in the cache from peers:",d+e.rangeEnd),this.thetaCtx.cache.set(d+e.rangeEnd,[{data:t.data.slice(0),url:t.url},l,e]),a.processFragment(e.url,"fromPeer",t.data.byteLength,s-n),a.processFragmentReq(r,"fragment_req_replied");var g=o.peers[r];try{t.invoice?(f.default.debug("Sending payment to "+t.invoice.address),o.sendPayment(t.invoice,g)):f.default.debug("No invoice is included in peer response. Skipping payment.")}catch(e){f.default.error("Error sending payment: ",e)}i.onSuccess(u,l,e)}},{key:"loadFromCDN",value:function(e,t,r,a){var n=Math.floor(Date.now()),o=this,i=new XMLHttpRequest;try{i.open("GET",e.url,!0)}catch(t){return void r.onError({code:i.status,text:t.message},e,i)}var u=a[a.length-1];e.rangeStart=Math.floor(u*(t/e.totalNum)),t===e.totalNum?e.rangeEnd=u:e.rangeEnd=Math.floor(u*((t+1)/e.totalNum))-1,f.default.info("IMPROCE DEBUG - start:"+e.rangeStart+", end:"+e.rangeEnd+", index:"+t+", total:"+e.totalNum),e.rangeEnd&&i.setRequestHeader("Range","bytes="+e.rangeStart+"-"+e.rangeEnd),i.responseType=e.responseType,i.callbacks=r;var l=this.thetaCtx.playerStats,s=this.thetaCtx.p2p;i.onload=function(c){f.default.info(i.response);var d=i.response;if(d){var g=Object.assign({},r),h=g.onSuccess,p=o.thetaCtx.cache,y={size:d.byteLength,loaded:d.byteLength,trequest:performance.now()};i.callbacks.onSuccess=function(r,i,c){f.default.info("On Success ctx: ",c),s.updateGetFragResults("CDN","success",1);var d=Math.floor(Date.now()),g=d-n;if(f.default.info("getFragment from CDN, "+r.data.byteLength+" bytes takes "+g+" ms"),l.processFragment(c.url+"undefined","fromCDN",r.data.byteLength,d-n),!o.integrityCheck(r.data.slice(0)))return void f.default.error("segment integrity check (from CDN) fails, skip loading");var y=o._getNewUrl(c.url);if(f.default.info("New URL before set cache is: ",y),o.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:r.data.byteLength},peer:null}),a[t]=r.data,f.default.log("IMPROVE DEBUG - change data[index]:",t,a[t]),f.default.log("SPLIT DEBUG - data before newRes:",a),o._checkData(a)){f.default.log("IMPROVE DEBUG - check data returns true:",a);var m={url:r.url,data:a.reduce(function(e,t){return o._appendBuffer(e,t)},new ArrayBuffer)};p.set(y+"undefined",[{data:m.data.slice(0),url:r.url},i,c]),f.default.log("SPLIT DEBUG - is newRes data length match:",m.data.byteLength===u),f.default.log("SPLIT DEBUG - newRes:",m),h(m,i,e)}else f.default.log("IMPROVE DEBUG - check data returns false:",a)};var m={url:i.responseURL,data:d};i.onreadystatechange=o.readystatechange.bind(o),i.callbacks.onSuccess(m,y,e)}},i.send()}},{key:"readystatechange",value:function(e){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"readystatechange",this).call(this,e)}},{key:"_getSequence",value:function(e){for(var t=[],r=0;r<e;r++)t[r]=r;return t=this._shuffle(t)}},{key:"_shuffle",value:function(e){for(var t=e.length,r=void 0,a=void 0;t>0;)a=Math.floor(Math.random()*t),t--,r=e[t],e[t]=e[a],e[a]=r;return e}},{key:"_appendBuffer",value:function(e,t){if(!e||!e.byteLength)return t;if(!t||!t.byteLength)return e;var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),e.byteLength),r.buffer}},{key:"_checkData",value:function(e){for(var t=0;t<e.length;t++)if(void 0===e[t])return!1;return!0}},{key:"_changeCJUrl",value:function(e){var t=e.split("/media_");return t[0]+"/media_"+t[1].split("_")[1]}},{key:"_byPassQueryUrl",value:function(e){var t=e;if(e.includes(".ts?")){t=e.split(".ts?")[0]+".ts"}return t}},{key:"_getCDNUrl",value:function(e,t){var r=e.split("/live/")[1];f.default.info("In get CDN url, url is: "+e+". val = "+r);var a="";return a=t?Object.keys(t).find(function(e){return t[e]===r}):"",f.default.log("Get CDN url: ",a),a}},{key:"_getNewUrl",value:function(e){var t=e;return"cjhellothetatestnet"===this.thetaCtx.p2p.videoId?t=this._changeCJUrl(e):this.thetaCtx.p2p.segUrlBypassQuery&&(t=this._byPassQueryUrl(e)),t=this._byPassQueryUrl(t)}},{key:"loadFromUCN",value:function(e,r,a){var n=this;f.default.info("ThetaHlsJsFragmentLoader: loadFromUCN");var o=this,i=this.thetaCtx.cache,u=a.onSuccess,s=Math.floor(Date.now()),c=this.thetaCtx.playerStats;a.onSuccess=function(e,t,r){var a=Math.floor(Date.now()),l=a-s;if(f.default.info("getFragment from UCN, "+e.data.byteLength+" bytes takes "+l+" ms"),c.processFragment(r.url,"fromPeer",e.data.byteLength,a-s),!n.integrityCheck(e.data.slice(0)))return void f.default.error("segment integrity check (from UCN) fails, skip loading");var d=o._getCDNUrl(r.url,r.ucnMap);i.set(d+r.rangeEnd,[{data:e.data.slice(0),url:e.url},t,r]),n.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.P2P_INBOUND,stats:{size:e.data.byteLength},peer:null}),u(e,t,r)},l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"load",this).call(this,e,r,a)}},{key:"loadFromCDN_old",value:function(e,r,a){var n=this;f.default.info("ThetaHlsJsFragmentLoader: loadFromCDN"),f.default.info("Loading url: ",e.url,e.rangeEnd);var o=this.thetaCtx.cache,i=a.onSuccess,u=Math.floor(Date.now()),s=this.thetaCtx.playerStats,c=this.thetaCtx.p2p,d=this;a.onSuccess=function(e,t,r){f.default.info("On Success ctx: ",r.rangeEnd,r),f.default.info("IMPROVE DEBUG - In old cdn, p2p object:",c),c.updateGetFragResults("CDN","success",5);var a=Math.floor(Date.now()),l=a-u;if(f.default.info("getFragment from CDN, "+e.data.byteLength+" bytes takes "+l+" ms"),s.processFragment(r.url,"fromCDN",e.data.byteLength,a-u),!n.integrityCheck(e.data.slice(0)))return void f.default.error("segment integrity check (from CDN) fails, skip loading");var g=d._getNewUrl(r.url);f.default.info("New URL before set cache is: ",g,r.rangeEnd),o.set(g+r.rangeEnd,[{data:e.data.slice(0),url:e.url},t,r]),n.thetaCtx.trigger(Theta.Events.TRAFFIC,{type:Theta.TrafficType.CDN,stats:{size:e.data.byteLength},peer:null}),i(e,t,r)},l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"load",this).call(this,e,r,a)}},{key:"_getCDNLoadedPercent",value:function(e){var t=e.CDN?e.CDN.success:0,r=0;Object.keys(e).forEach(function(t){"CDN"!==t&&(r+=e[t].success)});var a=r+t;return f.default.info("IMPROVE DEBUG - calc cdn percentage: peerNum:"+r+", cdnNum:"+t),a?t/a:1}}],[{key:"setDebug",value:function(e){f.default.setLoggingEnabled(e)}},{key:"toggleUseCDN",value:function(){c=!c}}]),t}(Hls.DefaultConfig.loader);t.default=d,e.exports=t.default},function(e,t,r){"use strict";function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),o=!1,i=function(){function e(){a(this,e)}return n(e,null,[{key:"isLoggingEnabled",value:function(){return o}},{key:"setLoggingEnabled",value:function(e){o=e}},{key:"maybeLog",value:function(e){if(this.isLoggingEnabled()){for(var t,r=new Date,a=arguments.length,n=Array(a>1?a-1:0),o=1;o<a;o++)n[o-1]=arguments[o];(t=console).log.apply(t,["["+r.toLocaleString()+"][THETA]["+e+"]"].concat(n))}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["info"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["warn"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["debug"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.maybeLog.apply(this,["error"].concat(t))}}]),e}();t.default=i,e.exports=t.default}])});